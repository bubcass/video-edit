<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Video Redactor (CDN auto-fallback)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f1115;color:#eaeaea;margin:0}
  .wrap{max-width:960px;margin:0 auto;padding:12px}
  h1{font-size:18px;margin:6px 0 10px;color:#cde}
  .panel{background:#131721;border:1px solid #202533;border-radius:12px;padding:12px;margin:10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:#2d6cdf;color:#fff;border:0;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn.ghost{background:#39414a}
  #stage{position:relative;display:inline-block;border:1px solid #202533;border-radius:8px;overflow:hidden;background:#111}
  #vid{width:640px;max-width:100%;height:auto;display:block}
  #overlay{position:absolute;left:0;top:0;pointer-events:auto}
  ul{list-style:none;margin:0;padding:0}
  li{background:#161b22;border:1px solid #202533;border-radius:8px;padding:6px 8px;margin:4px 0;font-size:13px}
  progress{width:100%;height:12px}
  #diag{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;color:#9db;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Web Video Redactor</h1>

  <div class="panel">
    <div class="row">
      <input id="file" type="file" accept="video/*" />
      <button class="btn" id="loadBtn">Load video</button>
      <span id="meta"></span>
    </div>
  </div>

  <div class="panel">
    <div id="stage">
      <video id="vid" controls crossorigin="anonymous"></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="play">Play</button>
      <button class="btn ghost" id="pause">Pause</button>
      <button class="btn ghost" id="startNow">Start = now</button>
      <button class="btn ghost" id="endNow">End = now</button>
      <span id="timeLbl"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="addBlackout">Add blackout</button>
      <button class="btn ghost" id="addMute">Add mute</button>
      <button class="btn ghost" id="clearSel">Clear selection</button>
    </div>
  </div>

  <div class="panel" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div><h3>Blackouts</h3><ul id="blkList"></ul></div>
    <div><h3>Mutes</h3><ul id="muteList"></ul></div>
  </div>

  <div class="panel">
    <div class="row">
      <button class="btn" id="startExport">Start Export</button>
    </div>
    <div style="margin-top:10px">
      <progress id="prog" value="0" max="1"></progress>
      <div id="progLbl">Idle</div>
      <div id="diag"></div>
    </div>
    <div id="outLinks" style="margin-top:8px"></div>
  </div>
</div>

<!-- A) Robust loader: try several CDNs/versions for the UMD wrapper -->
<script>
  const diagEl = document.getElementById('diag');
  const logd = (m) => { diagEl.textContent += (diagEl.textContent? "\n":"") + m; console.log(m); };

  // Candidate wrapper URLs (UMD exposes window.FFmpeg). Order matters.
  const WRAPPER_CANDIDATES = [
    // jsDelivr (latest 0.12)
    "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12/dist/umd/ffmpeg.js",
    // jsDelivr pinned
    "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js",
    // unpkg (latest 0.12)
    "https://unpkg.com/@ffmpeg/ffmpeg@0.12/dist/umd/ffmpeg.js",
    // unpkg pinned
    "https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"
  ];

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now(); // cache-bust
      s.crossOrigin = "anonymous";
      s.referrerPolicy = "no-referrer";
      s.onload = () => resolve(src);
      s.onerror = () => reject(new Error('load failed: ' + src));
      document.head.appendChild(s);
    });
  }

  async function ensureWrapper() {
    for (const url of WRAPPER_CANDIDATES) {
      try {
        logd('Trying wrapper: ' + url);
        await loadScript(url);
        if (window.FFmpeg) {
          logd('✅ Loaded wrapper: ' + url);
          return url;
        } else {
          logd('Wrapper loaded but window.FFmpeg is missing (unexpected): ' + url);
        }
      } catch (e) {
        logd('❌ ' + e.message);
      }
    }
    throw new Error('No wrapper could be loaded from any CDN.');
  }

  // Build a matching core URL (single-thread UMD) on the SAME CDN base
  function coreFromWrapper(wrapperUrl) {
    // swap package name and path
    // e.g. https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js
    //  -> https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/umd/ffmpeg-core.js
    const vMatch = wrapperUrl.match(/@ffmpeg\/ffmpeg@([^/]+)/);
    const ver = vMatch ? vMatch[1] : "0.12";
    const base = wrapperUrl.split('@ffmpeg/ffmpeg@')[0]; // keep CDN host/prefix
    const coreUrl = `${base}@ffmpeg/core@${ver}/dist/umd/ffmpeg-core.js`;
    logd('Core candidate: ' + coreUrl);
    return coreUrl;
  }

  // Expose a promise for the app module to await
  window.__loadFFmpeg = (async () => {
    const wrapperUrl = await ensureWrapper();
    const coreUrl = coreFromWrapper(wrapperUrl);
    return { wrapperUrl, coreUrl };
  })();
</script>

<!-- B) App logic -->
<script type="module">
  const diag = document.getElementById('diag');
  const logd = (m)=>{ diag.textContent += (diag.textContent? "\n":"") + m; console.log(m); };

  // Wait for the wrapper + derived core URL
  let wrapperUrl, coreUrl;
  try {
    ({ wrapperUrl, coreUrl } = await window.__loadFFmpeg);
  } catch (e) {
    alert("FFmpeg wrapper not loaded. See diagnostics below.");
    throw e;
  }

  if (!window.FFmpeg) {
    alert("window.FFmpeg missing after wrapper load.");
    throw new Error("FFmpeg wrapper missing");
  }

  const { createFFmpeg, fetchFile } = window.FFmpeg;

  // Create ffmpeg instance with the corePath we derived from the wrapper URL
  const ffmpeg = createFFmpeg({ log: true, corePath: coreUrl });

  // ---- your app (unchanged below) ----
  const $ = (id)=>document.getElementById(id);
  const fileEl=$("file"), loadBtn=$("loadBtn"), vid=$("vid");
  const overlay=$("overlay"); const ctx=overlay.getContext("2d");
  const prog=$("prog"), progLbl=$("progLbl"), outLinks=$("outLinks");
  const blkList=$("blkList"), muteList=$("muteList");
  const timeLbl=$("timeLbl"), meta=$("meta");

  let ffmpegLoaded=false, selection=null, dragging=false, dragStart=null;
  let startMark=null, endMark=null, blackouts=[], mutes=[], inputName="input.mp4";

  async function ensureFFmpeg(){ if(!ffmpegLoaded){ progLbl.textContent="Loading FFmpeg…"; await ffmpeg.load(); ffmpegLoaded=true; progLbl.textContent="Ready"; } }
  function fmt(s){ if(!isFinite(s)) return "--:--"; s|=0; const h=(s/3600)|0,m=((s%3600)/60)|0,ss=(s%60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
  function fitCanvas(){ const r=vid.getBoundingClientRect(); overlay.width=r.width; overlay.height=r.height; drawOverlay(); }
  function videoRect(){ const vw=vid.videoWidth,vh=vid.videoHeight,cw=overlay.width,ch=overlay.height; if(!vw||!vh) return {x:0,y:0,w:cw,h:ch,scaleX:1,scaleY:1}; const s=Math.min(cw/vw,ch/vh); const dw=Math.round(vw*s),dh=Math.round(vh*s); const ox=((cw-dw)/2)|0, oy=((ch-dh)/2)|0; return {x:ox,y:oy,w:dw,h:dh,scaleX:vw/dw,scaleY:vh/dh}; }
  function canvasToVideo(pt){ const r=videoRect(); const cx=Math.max(r.x,Math.min(pt.x,r.x+r.w)), cy=Math.max(r.y,Math.min(pt.y,r.y+r.h)); return { x: Math.round((cx-r.x)*r.scaleX), y: Math.round((cy-r.y)*r.scaleY) }; }
  function videoToCanvasRect(rect){ const r=videoRect(); return { x:Math.round(r.x+rect.x/r.scaleX), y:Math.round(r.y+rect.y/r.scaleY), w:Math.round(rect.w/r.scaleX), h:Math.round(rect.h/r.scaleY) }; }
  function drawOverlay(){ ctx.clearRect(0,0,overlay.width,overlay.height); if(selection){ const r=videoToCanvasRect(selection); ctx.strokeStyle="#00E5FF"; ctx.setLineDash([6,3]); ctx.lineWidth=2; ctx.strokeRect(r.x,r.y,r.w,r.h); ctx.setLineDash([]); } }
  window.addEventListener("resize",fitCanvas);
  vid.addEventListener("loadedmetadata",fitCanvas);
  vid.addEventListener("timeupdate",()=> timeLbl.textContent = `${fmt(vid.currentTime)} / ${fmt(vid.duration)}`);
  overlay.addEventListener("mousedown",(e)=>{ if(!vid.videoWidth) return alert("Load a video first."); const bb=overlay.getBoundingClientRect(); const v0=canvasToVideo({x:e.clientX-bb.left,y:e.clientY-bb.top}); dragging=true; dragStart=v0; selection={x:v0.x,y:v0.y,w:1,h:1}; drawOverlay(); });
  window.addEventListener("mousemove",(e)=>{ if(!dragging) return; const bb=overlay.getBoundingClientRect(); const v1=canvasToVideo({x:e.clientX-bb.left,y:e.clientY-bb.top}); selection={x:Math.min(dragStart.x,v1.x),y:Math.min(dragStart.y,v1.y),w:Math.abs(v1.x-dragStart.x),h:Math.abs(v1.y-dragStart.y)}; drawOverlay(); });
  window.addEventListener("mouseup",()=> dragging=false);
  $("clearSel").onclick=()=>{ selection=null; drawOverlay(); };
  $("play").onclick=()=> vid.play();
  $("pause").onclick=()=> vid.pause();
  $("startNow").onclick=()=>{ startMark=vid.currentTime; alert(`Start = ${startMark.toFixed(2)}s`); };
  $("endNow").onclick=()=>{ endMark=vid.currentTime; alert(`End = ${endMark.toFixed(2)}s`); };
  function renderLists(){ blkList.innerHTML = blackouts.map((b,i)=>`<li>#${i+1} ${b.start.toFixed(1)}–${b.end.toFixed(1)}s</li>`).join(""); muteList.innerHTML = mutes.map((m,i)=>`<li>#${i+1} ${m.start.toFixed(1)}–${m.end.toFixed(1)}s</li>`).join(""); }
  $("addBlackout").onclick=()=>{ if(startMark==null||endMark==null||!selection) return alert("Set start/end and draw an area first."); blackouts.push({start:startMark,end:endMark,rect:selection}); renderLists(); };
  $("addMute").onclick=()=>{ if(startMark==null||endMark==null) return alert("Set start/end first."); mutes.push({start:startMark,end:endMark}); renderLists(); };

  $("loadBtn").onclick=async()=>{
    const f=$("file").files&&$("file").files[0];
    if(!f) return alert("Choose a video file.");
    await ensureFFmpeg();
    const ext=(f.name.split(".").pop()||"mp4");
    window.inputName=`input_${Date.now()}.`+ext;
    ffmpeg.FS("writeFile", window.inputName, await fetchFile(f));
    vid.src=URL.createObjectURL(f); vid.load();
    meta.textContent=`Loaded: ${f.name}`;
  };

  function buildFilters(){
    const vparts=window.blackouts?.map(b=>`drawbox=x=${b.rect.x}:y=${b.rect.y}:w=${b.rect.w}:h=${b.rect.h}:color=black@1:t=fill:enable='between(t,${b.start},${b.end})'`)||[];
    const aparts=window.mutes?.map(m=>`volume=0:enable='between(t,${m.start},${m.end})'`)||[];
    const v=vparts.length?vparts.join(","):"null";
    const a=aparts.length?aparts.join(","):"anull";
    return { filterComplex:`[0:v]${v}[vout];[0:a]${a}[aout]`, maps:["-map","[vout]","-map","[aout]"] };
  }

  $("startExport").onclick=async()=>{
    if(!ffmpegLoaded) await ensureFFmpeg();
    if(!vid.src) return alert("Load a video first");
    const { filterComplex, maps } = buildFilters();
    prog.value=0; progLbl.textContent="Encoding MP4…";
    await ffmpeg.run("-i",window.inputName,"-filter_complex",filterComplex,...maps,"-c:v","libx264","-crf","23","-preset","veryfast","-c:a","aac","-movflags","+faststart","out.mp4");
    const mp4 = ffmpeg.FS("readFile","out.mp4");
    const url = URL.createObjectURL(new Blob([mp4.buffer],{type:"video/mp4"}));
    outLinks.innerHTML = `<a class="btn" href="${url}" download="redacted.mp4">Download MP4</a>`;
    prog.value=1; progLbl.textContent="Done!";
  };
</script>
</body>
</html>
